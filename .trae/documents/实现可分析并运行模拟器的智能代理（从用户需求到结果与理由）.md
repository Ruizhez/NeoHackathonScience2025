## 目标概述
- 让用户上传 Python 模拟器（如 `simulators/H20E.py`），Agent 自动分析模拟器的用途、输入参数与输出指标。
- 用户用自然语言描述需求（目标、约束、偏好），Agent 将需求转为可执行的参数选择计划，运行多组输入，输出结果与选择理由，并生成可复用的结构化 JSON。

## 上传与接入
- 支持上传/指定路径的 Python 文件；在隔离执行环境中加载模块（importlib），不修改原文件。
- 约定最小接口：
  - 入口函数：命名约定如 `simulate_*`（例如 `simulate_electrolysis`），返回 dict 或具名对象。
  - 支持从 `__main__` 参数块推断默认实验配置。
- 失败兜底：若未找到约定函数，回退到 AST/inspect 搜索具有数值入参且返回结构化 dict 的函数。

## 模拟器自动分析
- 静态分析（AST）：
  - 解析函数签名、默认值、类型提示、docstring；收集常量（如物理常数）。
  - 提取可优化的参数（float/int/bool/enum），识别时间、温度、压力、效率等物理量。
- 动态探测（安全受限）：
  - 对少量安全参数组合做快速试运行，观察输出结构与关键指标（如 `V_H2_L`、`V_O2_L`）。
- 生成 `SimulatorSpec`：
  - `inputs`: 名称、类型、范围/默认值、单位、含义（从 docstring/常量推断）。
  - `outputs`: 键名、单位、含义与计算来源。
  - `constraints`: 基于注释与物理常识（例如效率∈[0,1]）。

## 需求理解（自然语言→优化问题）
- 将用户需求解析为：
  - 目标函数：如“最大化 10 分钟时的 `V_H2_L`”。
  - 约束集合：如“电流 ≤ 5A”“温度在 20-60℃”“效率≥0.8”。
  - 权重与偏好：若包含多目标（如同时关注 `V_H2_L` 与能耗），使用加权或 Pareto。
- 需求到参数映射：
  - 用 LLM 对齐需求与 `SimulatorSpec` 的输入/输出名，避免用户用自然语言与代码命名不一致。

## 参数选择策略
- 初始策略：
  - 网格/拉丁超立方采样，在约束内生成候选；数量可配置（如 20-100）。
  - 如指明目标时间点（例如 600s），在模拟器中直接观测对应输出值。
- 迭代改进：
  - 基于候选结果的梯度启发或贝叶斯优化（若后续引入），现在先提供启发式重采样（在表现好的区域细化）。
- 选择 K 组最优输入（默认 3-5 组），记录每组的选择原因（目标值/约束满足/与需求关键词的匹配度）。

## 执行与监控
- 以受限执行环境运行每个候选：
  - 超时、内存限制、禁止 I/O 与网络。
  - 捕获异常并在结果中标注失败样本。
- 结果规范化：输入参数、关键输出、派生指标（例如体积峰值、单位换算）。

## 输出与解释
- 返回结构化 JSON：
  - `experiment_name`：来自模拟器/需求摘要（如 `H2 Electrolysis`）。
  - `experiment_description`：需求与模拟器解读的合并描述。
  - `runs`: 数组，包含 `inputs`、`outputs`、`reason`、`constraints_satisfied`。
  - `selection_summary`: 选择策略与综合理由。
- 可选生成 Markdown/文本报告：
  - 参数对目标的影响简述，趋势与边界案例说明。

## 存储与可复用
- 统一落盘：
  - 写入 `Experiments/<timestamp>_Experiment_<name>/metadata.json`（与当前解析器一致）。
  - 同步写入 SQLite：`experiments` 与 `experiment_data`/`runs` 表，以便后续检索与对比（复用已存在的本地DB能力，扩展表结构以容纳 `runs`）。
- 可复跑：
  - 记录环境（Python 版本、依赖）、模拟器文件哈希，确保复现实验。

## 安全与限制
- 沙箱：限制 `exec` 作用域，仅允许导入白名单库（numpy、math 等），禁用文件写入与网络。
- 超时与资源配额：每次运行限定时长与内存，避免死循环与大规模数据生成。
- 失败报告：明确标注运行与约束失败的原因，不中断整个流程。

## 与现有代码的集成点
- LLM 能力：沿用 `spoon-core/spoon_ai/chat.py` 的 `ChatBot.ask(...)` 接口解析需求与生成解释。
- 存储：复用 `PDF_Experiment_Parser.py` 的本地保存逻辑，扩展 DB 入库结构以支持多轮运行结果。
- 示例适配：以 `simulators/H20E.py` 为首个适配对象，入口函数 `simulate_electrolysis(...)`。

## 交付内容
- 新增模块：`simulator_agent/`（分析器、运行器、需求翻译器、计划器、结果打包器）。
- CLI：支持 `--sim /path/to/simulator.py --demand "..." --json-out ...`，输出 JSON + 可选落盘。
- 文档：上传需求模板与示例（单目标、多目标、含约束）。

## 后续增强（可选）
- 引入贝叶斯优化与多目标 Pareto 前沿。
- 支持更通用的模拟器协议（类实例化、状态型模拟）。
- 图形化报告（趋势曲线、敏感性分析）。

请确认该实现方案，我将据此创建模块、接入 CLI、完成首个模拟器的端到端演示并验证。